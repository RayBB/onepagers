<!DOCTYPE html>
<html>
<head>
    <title>Kagi Upload and Summarize</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
</head>
<body>
    <h1>Upload to somewhere and Summarize on Kagi</h1>

    <input type="file" id="fileInput" class="filepond" multiple />

    <p id="responseUrl"></p>

    <div id="loading" style="display: none; text-align: center;">
        <p>Loading...</p>
    </div>

    <div>
        <h2>Previously Uploaded Files</h2>
        <ul id="uploadedFilesList"></ul>
    </div>

    <script src="https://unpkg.com/filepond/dist/filepond.js"></script>
    <script>
        const fileInput = document.getElementById("fileInput");
        const responseUrl = document.getElementById("responseUrl");
        const loading = document.getElementById("loading");
        const uploadedFilesList = document.getElementById("uploadedFilesList");
        const uploadUrl = 'https://corsproxy.org/?' + encodeURIComponent("https://0x0.st");

        const pond = FilePond.create(fileInput, {
            allowMultiple: true,
            server: {
                process: (fieldName, file, metadata, load, error, progress, abort) => {
                    // Have to do it manually this way for now because https://github.com/pqina/filepond/issues/851
                    const formData = new FormData();
                    formData.append("file", file);

                    fetch(uploadUrl, {
                        method: "POST",
                        body: formData
                    })
                    .on('progress', (e) => {
                        progress(e.lengthComputable, e.loaded, e.total);
                    })
                    .then(response => response.text())
                    .then(url => {
                        window.open(buildKagiUrl(url), '_blank');

                        loading.style.display = "none";
                        responseUrl.innerHTML = `<strong>Response URL:</strong> <a href="${url}" target="_blank">${url}</a>`;

                        // Save urls to local storage and display it
                        const storedFiles = getFileHistory();
                        storedFiles.push({ name: file.name, url });
                        localStorage.setItem("uploadedFiles", JSON.stringify(storedFiles));
                        displayUploadedFiles();
                        load(url);
                    })
                    
                    .catch(err => {
                        loading.style.display = "none";
                        responseUrl.innerHTML = "Error uploading the file.";
                        console.error(err);
                        error(err);
                    });

                }
            }
        }
        );
        console.log("pond:", pond)

        function getFileHistory() {
            return JSON.parse(localStorage.getItem("uploadedFiles") || "[]");
        }

        function removeUploadedFileByName(name) {
            const updatedFiles = getFileHistory().filter(file => file.name !== name);
            localStorage.setItem("uploadedFiles", JSON.stringify(updatedFiles));
        }

        function buildKagiUrl(url) {
            return 'https://kagi.com/summarizer/index.html?target_language=&summary=takeaway&url=' + encodeURIComponent(url);
        }

        function displayUploadedFiles() {
            uploadedFilesList.innerHTML = "";
            getFileHistory().reverse().forEach(file => {
                const uploadedFileItem = document.createElement("li");
                uploadedFileItem.innerHTML += ` <a href="${file.url}" target="_blank">${file.name}</a> - <a href="${buildKagiUrl(file.url)}" target="_blank">Kagi</a>`;

                const b = document.createElement("button");
                b.innerText = "X";
                b.addEventListener("click", () => {
                    console.log('clicked')
                    removeUploadedFileByName(file.name);
                    uploadedFileItem.remove();
                });
                uploadedFileItem.prepend(b);// prepend so it goes first but we add it last so onclick doesn't get broken.
                
                uploadedFilesList.appendChild(uploadedFileItem);
            });
        }

        // Display previously uploaded files on page load
        displayUploadedFiles();
    </script>
</body>
</html>
