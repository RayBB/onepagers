<!DOCTYPE html>
<html>
<head>
    <title>Kagi Upload and Summarize</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
    <h1>Upload to somewhere and Summarize on Kagi</h1>

    <div id="dropZone" style="border: 2px dashed #ccc; padding: 20px; text-align: center;">
        <p>Drop a file anywhere on this page to upload</p>
    </div>

    <input type="file" id="fileInput" style="display: none;" multiple />

    <p id="responseUrl"></p>

    <div id="loading" style="display: none; text-align: center;">
        <p>Loading...</p>
    </div>

    <div>
        <h2>Previously Uploaded Files</h2>
        <ul id="uploadedFilesList"></ul>
    </div>

    <script>
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const responseUrl = document.getElementById("responseUrl");
        const loading = document.getElementById("loading");
        const uploadedFilesList = document.getElementById("uploadedFilesList");

        function uploadFile(file) {
            loading.style.display = "block";

            const formData = new FormData();
            formData.append("file", file);

            // const url = 'https://corsproxy.org/?' + encodeURIComponent("https://transfer.sh/" + file.name);
            const url = 'https://corsproxy.org/?' + encodeURIComponent("https://0x0.st/");
            fetch(url, {
                method: "POST",
                body: formData,
            })
            .then(response => response.text())
            .then(url => {
                url = url.replace("https://transfer.sh/", "https://transfer.sh/get/"); // Get the download URL
                window.open(buildKagiUrl(url), '_blank');

                loading.style.display = "none";
                responseUrl.innerHTML = `<strong>Response URL:</strong> <a href="${url}" target="_blank">${url}</a>`;
                
                // Save urls to local storage and display it
                const storedFiles = getFileHistory();
                storedFiles.push({ name: file.name, url });
                localStorage.setItem("uploadedFiles", JSON.stringify(storedFiles));
                displayUploadedFiles();

            })
            .catch(error => {
                loading.style.display = "none";
                responseUrl.innerHTML = "Error uploading the file.";
                console.error(error);
            });
        }
        function getFileHistory() {
            return JSON.parse(localStorage.getItem("uploadedFiles") || "[]");
        }
        function removeUploadedFileByName(name) {
            const updatedFiles = getFileHistory().filter(file => file.name !== name);
            localStorage.setItem("uploadedFiles", JSON.stringify(updatedFiles));
        }

        function buildKagiUrl(url) {
            return 'https://kagi.com/summarizer/index.html?target_language=&summary=takeaway&url=' + encodeURIComponent(url);
        }

        function displayUploadedFiles() {
            uploadedFilesList.innerHTML = "";
            getFileHistory().reverse().forEach(file => {
                const uploadedFileItem = document.createElement("li");
                uploadedFileItem.innerHTML += ` <a href="${file.url}" target="_blank">${file.name}</a> - <a href="${buildKagiUrl(file.url)}" target="_blank">Kagi</a>`;

                const b = document.createElement("button");
                b.innerText = "X";
                b.addEventListener("click", () => {
                    console.log('clicked')
                    removeUploadedFileByName(file.name);
                    uploadedFileItem.remove();
                });
                uploadedFileItem.prepend(b);// prepend so it goes first but we add it last so onclick doesn't get broken.
                
                uploadedFilesList.appendChild(uploadedFileItem);
            });
        }

        // Display previously uploaded files on page load
        displayUploadedFiles();

        // Listen for paste event on whole window, not just dropzone
        window.addEventListener("paste", (event) => {
            event.preventDefault();
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            Array.from(items).filter(item => item.kind === "file")
            .forEach(item => uploadFile(item.getAsFile()));
        });

        dropZone.addEventListener("drop", (event) => {
            event.preventDefault();
            Array.from(event.dataTransfer.files).forEach(uploadFile);
        });

        dropZone.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener("change", () => {
            Array.from(files).forEach(uploadFile);
        });

        dropZone.addEventListener("dragover", (event) => {
            event.preventDefault();
        });
    </script>
</body>
</html>
